<!-- Loading State -->
<div *ngIf="loading()" class="loading-overlay">
  <div class="loading-spinner"></div>
  <p>Loading board...</p>
</div>

<!-- Error State -->
<div *ngIf="error()" class="error-overlay">
  <div class="error-message">
    <h2>⚠️ Error</h2>
    <p>{{ error() }}</p>
    <button class="btn-primary" (click)="boardService.clearError(); router.navigate(['/boards'])">
      Go to Boards List
    </button>
  </div>
</div>

<!-- Board Content -->
<div *ngIf="!loading() && !error() && board()">
<!-- Dev-Test Toggle -->
<div class="toggle-container">
  <label class="switch">
    <input type="checkbox" [checked]="showDevTest()" (change)="toggleDevTest()" />
    <span class="slider"></span>
  </label>
  <span class="toggle-label">Dev/Test Toggle</span>
</div>

<!-- Team Member Bar -->
<div class="team-bar">
  <div class="team-bar-title">Team Members</div>
  <div class="team-member-list">
    <div class="team-member-chip" *ngFor="let member of getTeamMembers()">
      <span class="member-name">{{ member.name }}</span>
      <span
        *ngIf="showDevTest()"
        class="member-role"
        [class.dev]="member.isDev && !member.isTest"
        [class.test]="member.isTest && !member.isDev"
        [class.both]="member.isDev && member.isTest"
      >
        {{ getMemberRoleLabel(member) }}
      </span>
      <button class="member-action" type="button" (click)="openEditMember(member)" title="Edit member">
        <mat-icon>edit</mat-icon>
      </button>
      <button class="member-action" type="button" (click)="openDeleteMember(member)" title="Delete member">
        <mat-icon>delete</mat-icon>
      </button>
    </div>
    <button class="add-member-button" type="button" (click)="openAddMember()">+ Add Member</button>
    <button class="add-feature-button" type="button" (click)="openImportFeatureModal()">+ Add Feature</button>
  </div>
</div>

<div class="board-container" (mousemove)="onMouseMove($event)">
  <div class="board-content">
    <!-- Team Capacity Row (grid aligned with header) -->
    <div class="team-capacity-row" [style.gridTemplateColumns]="getGridTemplateColumns()">
      <div class="team-capacity-cell team-capacity-label">Team</div>
      <div class="team-capacity-cell team-capacity-label">Capacity</div>
      <div class="team-capacity-cell" *ngFor="let sprint of getDisplayedSprints()">
        <div class="capacity-header">
          <span class="capacity-title">{{ sprint.name }}</span>
          <button class="capacity-edit" type="button" (click)="openCapacityEditor(sprint.id)">
            Edit
          </button>
        </div>
        <div class="capacity-list">
          <div class="capacity-chip" *ngFor="let member of getTeamMembers()">
            <span class="capacity-name">{{ member.name }}</span>
            <span *ngIf="showDevTest()" class="capacity-role">{{
              getMemberRoleLabel(member)
            }}</span>
            <ng-container *ngIf="showDevTest(); else totalCapacity">
              <span *ngIf="member.isDev" class="capacity-value"
                >Dev: {{ getMemberSprintCapacity(member, sprint.id).dev }}</span
              >
              <span *ngIf="member.isTest" class="capacity-value"
                >Test: {{ getMemberSprintCapacity(member, sprint.id).test }}</span
              >
            </ng-container>
            <ng-template #totalCapacity>
              <span class="capacity-value"
                >Capacity:
                {{
                  getMemberSprintCapacity(member, sprint.id).dev +
                    getMemberSprintCapacity(member, sprint.id).test
                }}</span
              >
            </ng-template>
          </div>
        </div>
      </div>
    </div>

    <!-- Header Row (grid) -->
    <div class="sprint-header" [style.gridTemplateColumns]="getGridTemplateColumns()">
      <div class="sprint-header-cell feature-label">Feature</div>
      <div class="sprint-header-cell parking-lot-col">Parking Lot</div>
      <div class="sprint-header-cell" *ngFor="let sprint of getDisplayedSprints()">
        <div class="sprint-name">{{ sprint.name }}</div>
        <div class="sprint-metrics">
          <div class="metric-block">
            <div class="metric-label">Load</div>
            <div class="metric-values">
              <ng-container *ngIf="showDevTest(); else totalLoad">
                <span class="dev" [class.over-capacity]="isSprintOverCapacity(sprint.id, 'dev')"
                  >Dev: {{ getSprintTotals(sprint.id).dev }}</span
                >
                <span class="test" [class.over-capacity]="isSprintOverCapacity(sprint.id, 'test')"
                  >Test: {{ getSprintTotals(sprint.id).test }}</span
                >
                <span class="total" [class.over-capacity]="isSprintOverCapacity(sprint.id, 'total')"
                  >Total: {{ getSprintTotals(sprint.id).total }}</span
                >
              </ng-container>
              <ng-template #totalLoad>
                <span class="total" [class.over-capacity]="isSprintOverCapacity(sprint.id, 'total')"
                  >Total: {{ getSprintTotals(sprint.id).total }}</span
                >
              </ng-template>
            </div>
          </div>
          <div class="metric-block">
            <div class="metric-label">Capacity</div>
            <div class="metric-values">
              <ng-container *ngIf="showDevTest(); else totalCapacity">
                <span class="capacity-dev">Dev: {{ getSprintCapacityTotals(sprint.id).dev }}</span>
                <span class="capacity-test"
                  >Test: {{ getSprintCapacityTotals(sprint.id).test }}</span
                >
                <span class="capacity-total"
                  >Total: {{ getSprintCapacityTotals(sprint.id).total }}</span
                >
              </ng-container>
              <ng-template #totalCapacity>
                <span class="capacity-total"
                  >Total: {{ getSprintCapacityTotals(sprint.id).total }}</span
                >
              </ng-template>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Feature Rows -->
    <div
      class="feature-rows"
      cdkDropList
      cdkDropListOrientation="vertical"
      [cdkDropListData]="board()!.features"
      (cdkDropListDropped)="dropFeature($event)"
    >
      <div
        class="feature-row"
        *ngFor="let feature of board()!.features"
        [style.gridTemplateColumns]="getGridTemplateColumns()"
        cdkDrag
        [cdkDragData]="feature"
      >
      <!-- Feature Name -->
      <div class="feature-name">
        <span class="feature-drag-handle" cdkDragHandle>
          <mat-icon>drag_indicator</mat-icon>
        </span>
        <div class="feature-header">
          <h3>{{ feature.title }}</h3>
          <span class="azure-badge" *ngIf="feature.azureId">{{ feature.azureId }}</span>
          
          <!-- Feature actions menu (only for Azure features) -->
          <button 
            *ngIf="feature.azureId" 
            class="feature-menu-btn"
            mat-icon-button
            [matMenuTriggerFor]="featureMenu"
            (click)="$event.stopPropagation()">
            <mat-icon>more_vert</mat-icon>
          </button>
          
          <mat-menu #featureMenu="matMenu">
            <button mat-menu-item (click)="openRefreshFeatureModal(feature)">
              <mat-icon>refresh</mat-icon>
              <span>Refresh from Azure</span>
            </button>
            <button mat-menu-item (click)="openDeleteFeatureModal(feature)">
              <mat-icon>delete</mat-icon>
              <span>Delete Feature</span>
            </button>
          </mat-menu>
        </div>
        <span class="feature-total">Total: {{ getFeatureTotal(feature) }} pts</span>
      </div>

      <!-- Parking Lot -->
      <div class="sprint-column">
        <div
          cdkDropList
          [id]="'feature_' + feature.id + '_parkingLot'"
          [cdkDropListData]="getParkingLotStories(feature)"
          [cdkDropListConnectedTo]="getConnectedLists(feature.id)"
          class="story-list"
          (cdkDropListDropped)="drop($event)"
        >
          <app-story-card
            *ngFor="let story of getParkingLotStories(feature)"
            [story]="story"
            [parent]="this"
            cdkDrag
          ></app-story-card>
        </div>
      </div>

      <!-- Sprints (each sprint column is a direct grid child for aligned columns) -->
      <ng-container *ngFor="let sprint of getDisplayedSprints()">
        <div class="sprint-column" [attr.data-sprint-id]="sprint.id">
          <div
            cdkDropList
            [id]="'feature_' + feature.id + '_sprint_' + sprint.id"
            [cdkDropListData]="getStoriesInSprint(feature, sprint.id)"
            [cdkDropListConnectedTo]="getConnectedLists(feature.id)"
            class="story-list"
            (cdkDropListDropped)="drop($event)"
          >
            <app-story-card
              *ngFor="let story of getStoriesInSprint(feature, sprint.id)"
              [story]="story"
              [parent]="this"
              cdkDrag
            ></app-story-card>
          </div>
          <div class="sprint-feature-points">
            <div class="points-row">
              <ng-container *ngIf="getFeatureSprintDevTestTotals(feature, sprint.id) as fTotals">
                <span *ngIf="showDevTest() && fTotals.dev > 0" class="dev"
                  >Dev: {{ fTotals.dev }}</span
                >
                <span *ngIf="showDevTest() && fTotals.test > 0" class="test"
                  >Test: {{ fTotals.test }}</span
                >
                <span class="total">Total: {{ fTotals.total }}</span>
              </ng-container>
            </div>
            <div class="sprint-footer-name">{{ sprint.name }}</div>
          </div>
        </div>
      </ng-container>
      </div>
    </div>
  </div>
  <!-- close board-content -->

  <!-- Add Member Modal -->
  <div class="modal-backdrop" *ngIf="showAddMemberModal()">
    <div class="modal">
      <div class="modal-header">
        <h3>{{ editingMember() ? 'Edit Team Member' : 'Add Team Member' }}</h3>
        <button type="button" class="modal-close" (click)="closeAddMember()">×</button>
      </div>
      <div class="modal-body">
        <label class="modal-label">Name</label>
        <input
          class="modal-input"
          type="text"
          [ngModel]="newMemberName()"
          (ngModelChange)="newMemberName.set($event)"
          placeholder="Enter name"
        />
        <div *ngIf="memberFormError()" class="form-error">{{ memberFormError() }}</div>

        <ng-container *ngIf="showDevTest()">
          <label class="modal-label">Role</label>
          <select
            class="modal-input"
            [ngModel]="newMemberRole()"
            (ngModelChange)="newMemberRole.set($event)"
          >
            <option value="dev">Dev</option>
            <option value="test">Test</option>
          </select>
        </ng-container>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" type="button" (click)="closeAddMember()">Cancel</button>
        <button class="btn-primary" type="button" (click)="saveNewMember()">
          {{ editingMember() ? 'Save' : 'Add' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Delete Member Modal -->
  <div class="modal-backdrop" *ngIf="showDeleteMemberModal()">
    <div class="modal">
      <div class="modal-header">
        <h3>Delete Team Member</h3>
        <button type="button" class="modal-close" (click)="closeDeleteMember()">×</button>
      </div>
      <div class="modal-body">
        <div class="modal-label">Member</div>
        <input
          class="modal-input"
          type="text"
          [value]="memberToDelete()?.name || ''"
          disabled
        />
        <div class="warning-text">
          This will remove the member and all sprint capacities. This action cannot be undone.
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" type="button" (click)="closeDeleteMember()">Cancel</button>
        <button class="btn-danger" type="button" (click)="confirmDeleteMember()">Delete</button>
      </div>
    </div>
  </div>

  <!-- Capacity Editor Modal -->
  <div class="modal-backdrop" *ngIf="showCapacityModal()">
    <div class="modal modal-wide">
      <div class="modal-header">
        <h3>Edit Sprint Capacities</h3>
        <button type="button" class="modal-close" (click)="closeCapacityEditor()">×</button>
      </div>
      <div class="modal-body" *ngIf="selectedSprintId() as sprintId">
        <div class="capacity-edit-row" *ngFor="let member of getTeamMembers()">
          <div class="capacity-edit-name">
            {{ member.name }}
            <span *ngIf="showDevTest()" class="capacity-edit-role"
              >({{ getMemberRoleLabel(member) }})</span
            >
          </div>
          <div class="capacity-edit-inputs">
            <ng-container *ngIf="showDevTest(); else simpleCapacity">
              <input
                *ngIf="member.isDev"
                class="modal-input small"
                type="number"
                step="1"
                min="0"
                [value]="capacityEdits()[member.id]?.dev ?? 0"
                (input)="updateCapacityEdit(member.id, 'dev', $any($event.target).valueAsNumber)"
                placeholder="Dev"
              />
              <input
                *ngIf="member.isTest"
                class="modal-input small"
                type="number"
                step="1"
                min="0"
                [value]="capacityEdits()[member.id]?.test ?? 0"
                (input)="updateCapacityEdit(member.id, 'test', $any($event.target).valueAsNumber)"
                placeholder="Test"
              />
            </ng-container>
            <ng-template #simpleCapacity>
              <input
                class="modal-input small"
                type="number"
                step="1"
                min="0"
                [value]="member.isDev ? (capacityEdits()[member.id]?.dev ?? 0) : (capacityEdits()[member.id]?.test ?? 0)"
                (input)="updateCapacityEdit(member.id, member.isDev ? 'dev' : 'test', $any($event.target).valueAsNumber)"
                placeholder="Capacity"
              />
            </ng-template>
          </div>
        </div>
      </div>
      <div *ngIf="capacityFormError()" class="form-error">{{ capacityFormError() }}</div>
      <div class="modal-footer">
        <button class="btn-secondary" type="button" (click)="closeCapacityEditor()">Cancel</button>
        <button class="btn-primary" type="button" (click)="saveCapacityEdits()">Save</button>
      </div>
    </div>
  </div>

  <!-- Import Feature Modal -->
  <div class="modal-backdrop" *ngIf="showImportFeatureModal()" (click)="closeImportFeatureModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Import Feature from Azure DevOps</h3>
        <button type="button" class="modal-close" (click)="closeImportFeatureModal()">×</button>
      </div>
      <div class="modal-body">
        <div class="modal-label">Feature ID</div>
        <input
          class="modal-input"
          type="text"
          [(ngModel)]="importFeatureId"
          placeholder="Enter Azure DevOps Feature ID"
        />

        <div class="modal-label">Organization</div>
        <input
          class="modal-input"
          type="text"
          [value]="board()?.organization || ''"
          disabled
          placeholder="Auto-populated from board"
        />

        <div class="modal-label">Project</div>
        <input
          class="modal-input"
          type="text"
          [value]="board()?.project || ''"
          disabled
          placeholder="Auto-populated from board"
        />

        <div class="modal-label">Personal Access Token (PAT)</div>
        <input
          class="modal-input"
          type="password"
          [(ngModel)]="importPat"
          placeholder="Enter your Azure DevOps PAT"
        />

        <div class="checkbox-group">
          <label>
            <input
              type="checkbox"
              [(ngModel)]="rememberPatForImport" />
            Remember PAT for 10 minutes
          </label>
        </div>

        <div *ngIf="importError()" class="error-message-inline">
          {{ importError() }}
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" type="button" (click)="closeImportFeatureModal()" [disabled]="importLoading()">
          Cancel
        </button>
        <button class="btn-primary" type="button" (click)="importFeatureFromAzure()" [disabled]="importLoading()">
          {{ importLoading() ? 'Importing...' : 'Import Feature' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Refresh Feature Modal -->
  <div class="modal-backdrop" *ngIf="showRefreshFeatureModal()" (click)="closeRefreshFeatureModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Refresh Feature from Azure DevOps</h3>
        <button type="button" class="modal-close" (click)="closeRefreshFeatureModal()">×</button>
      </div>
      <div class="modal-body">
        <div class="modal-label">Feature</div>
        <input
          class="modal-input"
          type="text"
          [value]="selectedFeature()?.title || ''"
          disabled
        />

        <div class="modal-label">Azure ID</div>
        <input
          class="modal-input"
          type="text"
          [value]="selectedFeature()?.azureId || ''"
          disabled
        />

        <div class="modal-label">Organization</div>
        <input
          class="modal-input"
          type="text"
          [value]="board()?.organization || ''"
          disabled
          placeholder="Auto-populated from board"
        />

        <div class="modal-label">Project</div>
        <input
          class="modal-input"
          type="text"
          [value]="board()?.project || ''"
          disabled
          placeholder="Auto-populated from board"
        />

        <div class="modal-label">Personal Access Token (PAT) *</div>
        <input
          class="modal-input"
          type="password"
          [(ngModel)]="refreshPat"
          placeholder="Enter your Azure DevOps PAT"
        />

        <div class="checkbox-group">
          <label>
            <input 
              type="checkbox" 
              [(ngModel)]="rememberPatForRefresh" />
            Remember PAT for 10 minutes
          </label>
        </div>

        <div *ngIf="refreshError()" class="error-message-inline">
          {{ refreshError() }}
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" type="button" (click)="closeRefreshFeatureModal()" [disabled]="refreshLoading()">
          Cancel
        </button>
        <button class="btn-primary" type="button" (click)="refreshFeatureFromAzure()" [disabled]="refreshLoading()">
          {{ refreshLoading() ? 'Refreshing...' : 'Refresh Feature' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Delete Feature Modal -->
  <div class="modal-backdrop" *ngIf="showDeleteFeatureModal()" (click)="closeDeleteFeatureModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Delete Feature</h3>
        <button type="button" class="modal-close" (click)="closeDeleteFeatureModal()">×</button>
      </div>
      <div class="modal-body">
        <div class="modal-label">Feature</div>
        <input
          class="modal-input"
          type="text"
          [value]="featureToDelete()?.title || ''"
          disabled
        />

        <div class="modal-label">Azure ID</div>
        <input
          class="modal-input"
          type="text"
          [value]="featureToDelete()?.azureId || ''"
          disabled
        />

        <div class="warning-text">
          This will delete the feature and all associated user stories. This action cannot be undone.
        </div>

        <div *ngIf="deleteError()" class="error-message-inline">
          {{ deleteError() }}
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" type="button" (click)="closeDeleteFeatureModal()" [disabled]="deleteLoading()">
          Cancel
        </button>
        <button class="btn-danger" type="button" (click)="deleteFeature()" [disabled]="deleteLoading()">
          {{ deleteLoading() ? 'Deleting...' : 'Delete Feature' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Floating cursor name -->
  <div class="cursor-label" [ngStyle]="{ top: cursorY() + 'px', left: cursorX() + 'px' }">
    {{ cursorName() }}
  </div>
</div>
</div>
